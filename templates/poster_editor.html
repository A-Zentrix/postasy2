<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Poster - {{ poster.title }} - Postasy</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Fabric.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary-color: #4A90E2;
            --primary-hover: #357ABD;
            --secondary-color: #50E3C2;
            --background-dark: #2c3e50;
            --panel-dark: #34495e;
            --text-light: #ecf0f1;
            --border-color: #4a6a8a;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.2);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family-primary, 'Inter', -apple-system, BlinkMacSystemFont, sans-serif);
            background-color: var(--background-dark);
            color: var(--text-light);
            overflow: hidden;
        }

        .editor-container {
            display: flex;
            height: 100vh;
        }

        /* Left Panel Styling */
        .left-panel {
            width: 320px;
            background-color: var(--panel-dark);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 2px solid var(--border-color);
            overflow-y: auto;
        }

        .logo-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo-header i {
            font-size: 32px;
            color: var(--primary-color);
            margin-right: 12px;
        }

        .logo-header h2 {
            margin: 0;
            color: var(--text-light);
            font-size: 24px;
            font-weight: 700;
        }

        /* Main Tools */
        .main-tools {
            margin-bottom: 30px;
        }

        .tool-btn {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 15px 12px;
            background: none;
            border: 1px solid transparent;
            color: var(--text-light);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .tool-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-color);
            transform: translateX(5px);
        }

        .tool-btn.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            transform: translateX(5px);
        }

        .tool-btn i {
            margin-right: 15px;
            width: 20px;
            font-size: 18px;
        }

        .tool-separator {
            height: 1px;
            background-color: var(--border-color);
            margin: 15px 0;
        }

        /* Collapsible Panels */
        .panel {
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .panel-header {
            width: 100%;
            background: none;
            border: none;
            color: var(--text-light);
            padding: 18px 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .panel-header:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .panel-header.active {
            background-color: rgba(74, 144, 226, 0.2);
            color: var(--secondary-color);
        }

        .panel-header i:first-child {
            margin-right: 12px;
            color: var(--primary-color);
        }

        .toggle-icon {
            transition: transform 0.2s ease;
        }

        .panel-header.active .toggle-icon {
            transform: rotate(180deg);
        }

        .panel-content {
            padding: 0 15px 20px;
            display: none;
        }

        .panel-content.active {
            display: block;
        }

        /* Main Area Styling */
        .main-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background-color: var(--panel-dark);
            border-bottom: 2px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .poster-title-container {
            display: flex;
            align-items: center;
        }

        .poster-title-container i {
            font-size: 24px;
            color: var(--primary-color);
            margin-right: 12px;
        }

        .poster-title {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 22px;
            font-weight: bold;
            min-width: 200px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .poster-title:focus {
            background-color: rgba(255, 255, 255, 0.1);
            outline: none;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-secondary:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-success:hover {
            background-color: #229954;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Canvas & Loading Overlay */
        .canvas-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 40px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        .canvas-wrapper {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            background: white;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .spinner {
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 6px solid var(--secondary-color);
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-light);
        }

        #posterCanvas {
            display: block;
            border-radius: 12px;
        }

        /* Layer Items */
        .layer-item {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .layer-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-color);
            transform: translateX(5px);
        }

        .layer-item.active {
            background-color: rgba(74, 144, 226, 0.2);
            border-color: var(--primary-color);
            transform: translateX(5px);
        }

        .layer-name {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 500;
        }

        .layer-controls {
            display: flex;
            gap: 6px;
        }

        .layer-control-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .layer-control-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Properties Panel */
        .property-group {
            margin-bottom: 20px;
        }

        .property-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 8px;
            display: block;
        }

        .property-input, .property-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            transition: all 0.2s ease;
        }

        .property-input:focus, .property-select:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: rgba(255, 255, 255, 0.15);
        }

        .property-row {
            display: flex;
            gap: 10px;
        }

        .property-row .property-input {
            flex: 1;
        }

        .color-picker {
            width: 40px;
            height: 38px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .color-picker:hover {
            border-color: var(--primary-color);
        }

        /* Export Buttons */
        .export-btn {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 8px;
            background-color: rgba(74, 144, 226, 0.2);
            border: 1px solid var(--primary-color);
            color: var(--text-light);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            gap: 12px;
        }

        .export-btn:hover {
            background-color: rgba(74, 144, 226, 0.3);
            transform: translateX(5px);
        }

        .export-btn i {
            color: var(--primary-color);
            font-size: 16px;
        }

        /* Controls */
        .canvas-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 12px;
            background: rgba(52, 73, 94, 0.9);
            backdrop-filter: blur(10px);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .control-btn {
            width: 44px;
            height: 44px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .control-btn.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        /* Credit Section Styles */
        .credit-section {
            padding: 0;
        }

        .credit-option {
            margin-bottom: 12px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .credit-option:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-color);
        }

        .credit-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            position: relative;
            padding-left: 30px;
        }

        .credit-checkbox input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 20px;
            width: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--border-color);
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .credit-checkbox:hover input ~ .checkmark {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: var(--primary-color);
        }

        .credit-checkbox input:checked ~ .checkmark {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .credit-checkbox input:checked ~ .checkmark:after {
            display: block;
        }

        .credit-checkbox .checkmark:after {
            left: 6px;
            top: 2px;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .credit-label {
            margin-left: 8px;
            font-weight: 500;
        }

        .credit-preview {
            margin-top: 8px;
            padding: 8px 12px;
            background-color: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.3);
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-light);
            opacity: 0.9;
        }

        .preview-text {
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }

        /* Success/Error Messages */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
        }

        .message.success {
            background-color: var(--success-color);
            color: white;
        }

        .message.error {
            background-color: var(--danger-color);
            color: white;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .left-panel {
                width: 280px;
            }
            
            .canvas-container {
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .left-panel {
                position: absolute;
                left: -100%;
                width: 280px;
                height: 100vh;
                z-index: 40;
                transition: left 0.3s ease;
                box-shadow: var(--shadow-lg);
            }
            
            .left-panel.open {
                left: 0;
            }
            
            .main-header {
                padding: 15px 20px;
            }
            
            .poster-title {
                font-size: 18px;
            }
            
            .canvas-container {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <!-- Left Panel: Tools & Controls -->
        <aside class="left-panel">
            <div class="logo-header">
                <i class="fas fa-palette"></i>
                <h2>Postasy</h2>
            </div>

            <div class="main-tools">
                <!-- Basic Tools -->
                <button class="tool-btn active" id="selectTool" onclick="setTool('select')">
                    <i class="fas fa-mouse-pointer"></i><span>Select</span>
                </button>
                <button class="tool-btn" id="textTool" onclick="setTool('text')">
                    <i class="fas fa-font"></i><span>Add Text</span>
                </button>
                <button class="tool-btn" onclick="showShapesMenu(this)">
                    <i class="fas fa-shapes"></i><span>Add Shape</span>
                </button>
                
                <div class="tool-separator"></div>
                
                <button class="tool-btn" onclick="undoAction()">
                    <i class="fas fa-undo"></i><span>Undo</span>
                </button>
                <button class="tool-btn" onclick="redoAction()">
                    <i class="fas fa-redo"></i><span>Redo</span>
                </button>
                <button class="tool-btn" onclick="deleteSelected()">
                    <i class="fas fa-trash"></i><span>Delete</span>
                </button>
                <button class="tool-btn" onclick="enhanceTextClarity()" title="Enhance Text Clarity (Ctrl+E)">
                    <i class="fas fa-eye"></i><span>Enhance Text</span>
                </button>
            </div>

            <!-- Collapsible Panels -->
            <div class="panel-group">
                <div class="panel">
                    <button class="panel-header" onclick="togglePanel(this)">
                        <span><i class="fas fa-layer-group"></i> Layers</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </button>
                    <div class="panel-content" id="layersPanel">
                        <!-- Layer items will be dynamically added here -->
                        <p style="color: var(--text-light); opacity: 0.7; font-size: 14px;">Your layers will appear here.</p>
                    </div>
                </div>

                <div class="panel">
                    <button class="panel-header" onclick="togglePanel(this)">
                        <span><i class="fas fa-sliders-h"></i> Properties</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </button>
                    <div class="panel-content" id="propertiesPanel">
                        <p style="color: var(--text-light); opacity: 0.7; font-size: 14px;">Select an object to edit its properties.</p>
                    </div>
                </div>

                <div class="panel">
                    <button class="panel-header" onclick="togglePanel(this)">
                        <span><i class="fas fa-user-tag"></i> Credit Info</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </button>
                    <div class="panel-content">
                        <div class="credit-section">
                            <p style="color: var(--text-light); opacity: 0.8; font-size: 13px; margin-bottom: 15px;">
                                Add your business information to the poster
                            </p>
                            
                            <div class="credit-option">
                                <label class="credit-checkbox">
                                    <input type="checkbox" id="creditName" onchange="toggleCreditField('name')">
                                    <span class="checkmark"></span>
                                    <span class="credit-label">Full Name</span>
                                </label>
                                <div class="credit-preview" id="namePreview" style="display: none;">
                                    <span class="preview-text">{{ current_user.full_name or 'Your Name' }}</span>
                                </div>
                            </div>
                            
                            <div class="credit-option">
                                <label class="credit-checkbox">
                                    <input type="checkbox" id="creditBusiness" onchange="toggleCreditField('business')">
                                    <span class="checkmark"></span>
                                    <span class="credit-label">Business Name</span>
                                </label>
                                <div class="credit-preview" id="businessPreview" style="display: none;">
                                    <span class="preview-text">{{ current_user.business_name or 'Your Business' }}</span>
                                </div>
                            </div>
                            
                            <div class="credit-option">
                                <label class="credit-checkbox">
                                    <input type="checkbox" id="creditPhone" onchange="toggleCreditField('phone')">
                                    <span class="checkmark"></span>
                                    <span class="credit-label">Phone Number</span>
                                </label>
                                <div class="credit-preview" id="phonePreview" style="display: none;">
                                    <span class="preview-text">{{ current_user.phone or '+1 (555) 123-4567' }}</span>
                                </div>
                            </div>
                            
                            <div class="credit-option">
                                <label class="credit-checkbox">
                                    <input type="checkbox" id="creditAddress" onchange="toggleCreditField('address')">
                                    <span class="checkmark"></span>
                                    <span class="credit-label">Address</span>
                                </label>
                                <div class="credit-preview" id="addressPreview" style="display: none;">
                                    <span class="preview-text">{{ current_user.address or '123 Business St, City, State' }}</span>
                                </div>
                            </div>
                            
                            <div class="credit-option">
                                <label class="credit-checkbox">
                                    <input type="checkbox" id="creditWebsite" onchange="toggleCreditField('website')">
                                    <span class="checkmark"></span>
                                    <span class="credit-label">Website</span>
                                </label>
                                <div class="credit-preview" id="websitePreview" style="display: none;">
                                    <span class="preview-text">{{ current_user.website or 'www.yourwebsite.com' }}</span>
                                </div>
                            </div>
                            
                            <div class="credit-option">
                                <label class="credit-checkbox">
                                    <input type="checkbox" id="creditSocial" onchange="toggleCreditField('social')">
                                    <span class="checkmark"></span>
                                    <span class="credit-label">Social Media</span>
                                </label>
                                <div class="credit-preview" id="socialPreview" style="display: none;">
                                    <span class="preview-text">
                                        {% if current_user.facebook or current_user.instagram or current_user.twitter or current_user.linkedin %}
                                            {% if current_user.facebook %}Facebook: {{ current_user.facebook }}{% endif %}
                                            {% if current_user.instagram %}{% if current_user.facebook %}, {% endif %}Instagram: {{ current_user.instagram }}{% endif %}
                                            {% if current_user.twitter %}{% if current_user.facebook or current_user.instagram %}, {% endif %}Twitter: {{ current_user.twitter }}{% endif %}
                                            {% if current_user.linkedin %}{% if current_user.facebook or current_user.instagram or current_user.twitter %}, {% endif %}LinkedIn: {{ current_user.linkedin }}{% endif %}
                                        {% else %}
                                            @yourhandle
                                        {% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="credit-option">
                                <label class="credit-checkbox">
                                    <input type="checkbox" id="creditLogo" onchange="toggleCreditField('logo')">
                                    <span class="checkmark"></span>
                                    <span class="credit-label">Company Logo</span>
                                </label>
                                <div class="credit-preview" id="logoPreview" style="display: none;">
                                    <span class="preview-text">
                                        {% if current_user.logo_filename %}
                                            Logo: {{ current_user.logo_filename }}
                                        {% else %}
                                            No logo uploaded
                                        {% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="credit-option">
                                <label class="credit-checkbox">
                                    <input type="checkbox" id="creditEmail" onchange="toggleCreditField('email')">
                                    <span class="checkmark"></span>
                                    <span class="credit-label">Email Address</span>
                                </label>
                                <div class="credit-preview" id="emailPreview" style="display: none;">
                                    <span class="preview-text">{{ current_user.email }}</span>
                                </div>
                            </div>

                            <div class="credit-option">
                                <label class="credit-checkbox">
                                    <input type="checkbox" id="creditUsername" onchange="toggleCreditField('username')">
                                    <span class="checkmark"></span>
                                    <span class="credit-label">Username/ID</span>
                                </label>
                                <div class="credit-preview" id="usernamePreview" style="display: none;">
                                    <span class="preview-text">@{{ current_user.username }}</span>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="addSelectedCredits()">
                                <i class="fas fa-plus"></i>Add Selected Credits
                            </button>
                            
                            <div class="tool-separator" style="margin: 20px 0;"></div>
                            
                            <button class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="autoFillWhiteSpace()" title="Auto-Fill White Space (Ctrl+F)">
                                <i class="fas fa-magic"></i>Auto-Fill White Space
                            </button>
                            
                            <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="enhancedAutoFillWhiteSpace()" title="Enhanced Auto-Fill with Company Details">
                                <i class="fas fa-building"></i>Fill with Company Details
                            </button>
                            
                            <button class="btn btn-info" style="width: 100%; margin-bottom: 10px;" onclick="addCompanyLogo()" title="Add Company Logo">
                                <i class="fas fa-image"></i>Add Company Logo
                            </button>
                            
                            <p style="color: var(--text-light); opacity: 0.7; font-size: 12px; text-align: center; margin-top: 10px;">
                                Automatically adds your business info to empty areas
                            </p>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <button class="panel-header" onclick="togglePanel(this)">
                        <span><i class="fas fa-file-export"></i> Export</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </button>
                    <div class="panel-content">
                        <button class="export-btn" onclick="exportAs('png')">
                            <i class="fas fa-file-image"></i>Export as PNG
                        </button>
                        <button class="export-btn" onclick="exportAs('jpg')">
                            <i class="fas fa-file-image"></i>Export as JPG
                        </button>
                        <button class="export-btn" onclick="exportAs('pdf')">
                            <i class="fas fa-file-pdf"></i>Export as PDF
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Right Panel: Main Area -->
        <main class="main-area">
            <header class="main-header">
                <div class="poster-title-container">
                    <i class="fas fa-image"></i>
                    <input type="text" value="{{ poster.title }}" class="poster-title" id="posterTitle">
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="previewPoster()">
                        <i class="fas fa-eye"></i>Preview
                    </button>
                    <button class="btn btn-success" id="saveBtn" onclick="savePoster()">
                        <i class="fas fa-save"></i>Save Changes
                    </button>
                    <button class="btn btn-danger" onclick="deletePoster()" title="Delete Poster">
                        <i class="fas fa-trash"></i>Delete Poster
                    </button>
                    <a href="{{ url_for('poster.gallery') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i>Back to Gallery
                    </a>
                </div>
            </header>

            <div class="canvas-container">
                <div class="canvas-wrapper">
                    <!-- Poster Loading Overlay -->
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="spinner"></div>
                        <p class="loading-text">Loading your poster...</p>
                    </div>

                    <!-- The Actual Poster Canvas -->
                    <canvas id="posterCanvas"></canvas>
                </div>

                <!-- Canvas Controls -->
                <div class="canvas-controls">
                    <button class="control-btn" onclick="zoomOut()" title="Zoom Out">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="control-btn" onclick="fitToScreen()" title="Fit to Screen">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </button>
                    <button class="control-btn" onclick="zoomIn()" title="Zoom In">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Save Form (Hidden) -->
    <form id="saveForm" method="POST" style="display: none;">
        <input type="hidden" name="canvas_data" id="canvasData">
    </form>

    <script>
        console.log('🎨 Starting Postasy Editor Standalone...');

        // Global variables
        let canvas = null;
        let history = [];
        let historyStep = 0;
        let currentTool = 'select';
        let zoomLevel = 1;
        let backgroundImage = null;

        // Poster data
        const posterData = {
            id: {{ poster.id }},
            title: "{{ poster.title }}",
            filename: "{{ poster.filename }}",
            displayedFields: {{ poster.get_displayed_fields_list() | tojson }},
            userProfile: {
                full_name: "{{ current_user.full_name or '' }}",
                business_name: "{{ current_user.business_name or '' }}",
                phone: "{{ current_user.phone or '' }}",
                address: "{{ current_user.address or '' }}",
                website: "{{ current_user.website or '' }}",
                facebook: "{{ current_user.facebook or '' }}",
                instagram: "{{ current_user.instagram or '' }}",
                twitter: "{{ current_user.twitter or '' }}",
                linkedin: "{{ current_user.linkedin or '' }}",
                email: "{{ current_user.email or '' }}",
                username: "{{ current_user.username or '' }}",
                logo_filename: "{{ current_user.logo_filename or '' }}"
            }
        };

        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📐 DOM loaded, initializing standalone editor...');
            initializeEditor();
        });

        function initializeEditor() {
            try {
                console.log('🔧 Setting up standalone canvas...');
                
                // Create canvas with optimal dimensions
                const canvasWidth = 800;
                const canvasHeight = 600;
                
                canvas = new fabric.Canvas('posterCanvas', {
                    width: canvasWidth,
                    height: canvasHeight,
                    backgroundColor: '#ffffff',
                    preserveObjectStacking: true,
                    selection: true,
                    targetFindTolerance: 5,
                    perPixelTargetFind: true
                });
                
                console.log('✅ Standalone canvas created:', canvasWidth + 'x' + canvasHeight);
                
                // Setup canvas events
                setupCanvasEvents();
                
                // Load the poster image
                loadPosterImage();
                
                // Initialize UI
                updateToolbar();
                initializePanels();
                
                console.log('🚀 Standalone editor initialization complete');
                
            } catch (error) {
                console.error('❌ Standalone editor initialization failed:', error);
                hideLoading();
                showMessage('Failed to initialize the editor. Please refresh the page.', 'error');
            }
        }

        function setupCanvasEvents() {
            console.log('🔗 Setting up standalone canvas events...');
            
            canvas.on('selection:created', handleSelection);
            canvas.on('selection:updated', handleSelection);
            canvas.on('selection:cleared', clearSelection);
            canvas.on('object:modified', saveState);
            canvas.on('object:added', updateLayers);
            canvas.on('object:removed', updateLayers);
            canvas.on('mouse:down', handleCanvasClick);
            
            console.log('✅ Standalone canvas events configured');
        }

        function loadPosterImage() {
            console.log('🖼️ Loading poster image standalone...');
            
            const imageUrl = '/static/uploads/posters/' + posterData.filename;
            console.log('📂 Image URL:', imageUrl);
            
            // Create test image to verify accessibility
            const testImg = new Image();
            
            testImg.onload = function() {
                console.log('✅ Test image loaded successfully');
                console.log('📏 Image dimensions:', testImg.width + 'x' + testImg.height);
                
                // Load with Fabric.js
                fabric.Image.fromURL(imageUrl, function(fabricImg) {
                    if (!fabricImg) {
                        console.error('❌ Failed to create Fabric image');
                        hideLoading();
                        showMessage('Failed to load the poster image.', 'error');
                        return;
                    }
                    
                    console.log('✅ Fabric image created successfully');
                    
                    try {
                        // Calculate optimal scaling
                        const canvasWidth = canvas.getWidth();
                        const canvasHeight = canvas.getHeight();
                        const imgWidth = fabricImg.width;
                        const imgHeight = fabricImg.height;
                        
                        const scaleX = canvasWidth / imgWidth;
                        const scaleY = canvasHeight / imgHeight;
                        const scale = Math.min(scaleX, scaleY, 1);
                        
                        console.log('📐 Calculated scale:', scale);
                        
                        // Configure background image
                        fabricImg.set({
                            scaleX: scale,
                            scaleY: scale,
                            left: (canvasWidth - imgWidth * scale) / 2,
                            top: (canvasHeight - imgHeight * scale) / 2,
                            selectable: false,
                            evented: false,
                            name: 'background-image',
                            lockMovementX: true,
                            lockMovementY: true,
                            lockRotation: true,
                            lockScalingX: true,
                            lockScalingY: true,
                            hoverCursor: 'default',
                            moveCursor: 'default'
                        });
                        
                        // Clear canvas and add background
                        canvas.clear();
                        canvas.add(fabricImg);
                        canvas.sendToBack(fabricImg);
                        canvas.renderAll();
                        
                        // Store reference
                        backgroundImage = fabricImg;
                        
                        // Save initial state
                        saveState();
                        updateLayers();
                        
                        // Hide loading with smooth animation
                        setTimeout(() => {
                            hideLoading();
                            showMessage('Poster loaded successfully!', 'success');
                            console.log('🎉 Standalone poster loaded and editor ready!');
                        }, 500);
                        
                    } catch (error) {
                        console.error('❌ Error configuring image:', error);
                        hideLoading();
                        showMessage('Error setting up the poster image.', 'error');
                    }
                    
                }, {
                    crossOrigin: 'anonymous'
                });
            };
            
            testImg.onerror = function(e) {
                console.error('❌ Failed to load test image:', imageUrl, e);
                hideLoading();
                showMessage('The poster image could not be found. Please check if the image exists.', 'error');
            };
            
            // Set loading timeout
            setTimeout(() => {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay && !overlay.classList.contains('hidden')) {
                    console.error('⏰ Image loading timeout');
                    hideLoading();
                    showMessage('Image loading timed out. Please check your connection.', 'error');
                }
            }, 15000);
            
            testImg.src = imageUrl;
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            }
        }

        function showMessage(message, type = 'success') {
            // Remove existing messages
            const existingMessages = document.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());
            
            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(messageDiv);
            
            // Auto-remove after delay
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Panel management
        function initializePanels() {
            // Open the first panel by default
            const firstPanel = document.querySelector('.panel-header');
            if (firstPanel) {
                togglePanel(firstPanel);
            }
        }

        function togglePanel(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            // Toggle content
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                content.style.display = 'none';
                header.classList.remove('active');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            } else {
                content.classList.add('active');
                content.style.display = 'block';
                header.classList.add('active');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            }
        }

        // Tool management
        function setTool(tool) {
            currentTool = tool;
            updateToolbar();
            
            // Configure canvas for the tool
            switch(tool) {
                case 'select':
                    canvas.isDrawingMode = false;
                    canvas.selection = true;
                    canvas.defaultCursor = 'default';
                    break;
                case 'text':
                    canvas.isDrawingMode = false;
                    canvas.selection = false;
                    canvas.defaultCursor = 'text';
                    break;
                default:
                    canvas.isDrawingMode = false;
                    canvas.selection = false;
                    canvas.defaultCursor = 'crosshair';
            }
            
            canvas.renderAll();
        }

        function updateToolbar() {
            // Update active tool button
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const toolBtn = document.getElementById(currentTool + 'Tool');
            if (toolBtn) {
                toolBtn.classList.add('active');
            }
        }

        function handleCanvasClick(options) {
            if (currentTool === 'text') {
                const pointer = canvas.getPointer(options.e);
                addText(pointer.x, pointer.y);
            }
        }

        // Object creation functions
        function addText(x, y) {
            const text = new fabric.Textbox('Click to edit text', {
                left: x - 75,
                top: y - 15,
                width: 200,
                fontSize: 32,
                fill: '#4A90E2',
                fontFamily: 'Arial',
                fontWeight: '600',
                name: 'text-' + Date.now(),
                cornerStyle: 'circle',
                borderColor: '#4A90E2',
                cornerColor: '#4A90E2'
            });
            
            canvas.add(text);
            canvas.setActiveObject(text);
            setTool('select');
            saveState();
        }

        function addRectangle() {
            const rect = new fabric.Rect({
                left: 100,
                top: 100,
                width: 150,
                height: 100,
                fill: '#4A90E2',
                stroke: '#357ABD',
                strokeWidth: 2,
                rx: 10,
                ry: 10,
                name: 'rectangle-' + Date.now(),
                cornerStyle: 'circle',
                borderColor: '#4A90E2',
                cornerColor: '#4A90E2'
            });
            
            canvas.add(rect);
            canvas.setActiveObject(rect);
            saveState();
        }

        function addCircle() {
            const circle = new fabric.Circle({
                left: 100,
                top: 100,
                radius: 60,
                fill: '#50E3C2',
                stroke: '#4A90E2',
                strokeWidth: 2,
                name: 'circle-' + Date.now(),
                cornerStyle: 'circle',
                borderColor: '#4A90E2',
                cornerColor: '#4A90E2'
            });
            
            canvas.add(circle);
            canvas.setActiveObject(circle);
            saveState();
        }

        // Shape menu
        function showShapesMenu(btn) {
            const menu = document.createElement('div');
            menu.style.cssText = `
                position: absolute;
                background: var(--panel-dark);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                box-shadow: var(--shadow-lg);
                padding: 12px;
                z-index: 1000;
                display: flex;
                flex-direction: column;
                gap: 8px;
                min-width: 150px;
            `;
            
            const shapes = [
                { icon: 'fas fa-square', action: 'addRectangle', title: 'Rectangle' },
                { icon: 'fas fa-circle', action: 'addCircle', title: 'Circle' }
            ];
            
            shapes.forEach(shape => {
                const shapeBtn = document.createElement('button');
                shapeBtn.className = 'tool-btn';
                shapeBtn.innerHTML = `<i class="${shape.icon}"></i><span>${shape.title}</span>`;
                shapeBtn.onclick = function() {
                    window[shape.action]();
                    document.body.removeChild(menu);
                };
                menu.appendChild(shapeBtn);
            });
            
            const rect = btn.getBoundingClientRect();
            menu.style.left = (rect.right + 10) + 'px';
            menu.style.top = rect.top + 'px';
            
            document.body.appendChild(menu);
            
            // Remove menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function removeMenu(e) {
                    if (!menu.contains(e.target) && e.target !== btn) {
                        if (document.body.contains(menu)) {
                            document.body.removeChild(menu);
                        }
                        document.removeEventListener('click', removeMenu);
                    }
                });
            }, 10);
        }

        // Layer management
        function updateLayers() {
            const layersPanel = document.getElementById('layersPanel');
            const objects = canvas.getObjects().slice().reverse();
            
            let html = '';
            objects.forEach((obj, index) => {
                const actualIndex = objects.length - index - 1;
                const name = obj.name || obj.type + ' ' + (actualIndex + 1);
                const isSelected = canvas.getActiveObject() === obj;
                const isVisible = obj.visible !== false;
                
                html += `
                    <div class="layer-item ${isSelected ? 'active' : ''}" onclick="selectLayer(${actualIndex})">
                        <div class="layer-name">${name}</div>
                        <div class="layer-controls">
                            <button class="layer-control-btn" onclick="event.stopPropagation(); toggleLayerVisibility(${actualIndex})" title="Toggle Visibility">
                                <i class="fas fa-eye${isVisible ? '' : '-slash'}"></i>
                            </button>
                            ${obj.name !== 'background-image' ? `<button class="layer-control-btn" onclick="event.stopPropagation(); deleteLayer(${actualIndex})" title="Delete Layer">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            layersPanel.innerHTML = html || '<p style="color: var(--text-light); opacity: 0.7; font-size: 14px;">No layers</p>';
        }

        function selectLayer(index) {
            const objects = canvas.getObjects();
            const obj = objects[index];
            if (obj) {
                canvas.setActiveObject(obj);
                canvas.renderAll();
            }
        }

        function toggleLayerVisibility(index) {
            const objects = canvas.getObjects();
            const obj = objects[index];
            if (obj) {
                obj.set('visible', !obj.visible);
                canvas.renderAll();
                updateLayers();
            }
        }

        function deleteLayer(index) {
            const objects = canvas.getObjects();
            const obj = objects[index];
            if (obj && obj.name !== 'background-image') {
                canvas.remove(obj);
                saveState();
            }
        }

        // Selection handling
        function handleSelection() {
            updatePropertiesPanel();
            updateLayers();
        }

        function clearSelection() {
            clearPropertiesPanel();
            updateLayers();
        }

        // Properties panel
        function updatePropertiesPanel() {
            const activeObject = canvas.getActiveObject();
            const panel = document.getElementById('propertiesPanel');
            
            if (!activeObject || activeObject.name === 'background-image') {
                clearPropertiesPanel();
                return;
            }
            
            let html = '';
            
            // Position properties
            html += `
                <div class="property-group">
                    <label class="property-label">Position</label>
                    <div class="property-row">
                        <input type="number" class="property-input" placeholder="X" value="${Math.round(activeObject.left)}" onchange="updateObjectProperty('left', this.value)">
                        <input type="number" class="property-input" placeholder="Y" value="${Math.round(activeObject.top)}" onchange="updateObjectProperty('top', this.value)">
                    </div>
                </div>
            `;
            
            // Text-specific properties
            if (activeObject.type === 'textbox' || activeObject.type === 'text') {
                html += `
                    <div class="property-group">
                        <label class="property-label">Font Size</label>
                        <input type="number" class="property-input" value="${activeObject.fontSize}" onchange="updateObjectProperty('fontSize', this.value)">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Text Color</label>
                        <input type="color" class="color-picker" value="${activeObject.fill}" onchange="updateObjectProperty('fill', this.value)">
                    </div>
                `;
            }
            
            // Shape-specific properties
            if (activeObject.type === 'rect' || activeObject.type === 'circle') {
                html += `
                    <div class="property-group">
                        <label class="property-label">Fill Color</label>
                        <input type="color" class="color-picker" value="${activeObject.fill}" onchange="updateObjectProperty('fill', this.value)">
                    </div>
                `;
            }
            
            panel.innerHTML = html;
        }

        function clearPropertiesPanel() {
            document.getElementById('propertiesPanel').innerHTML = '<p style="color: var(--text-light); opacity: 0.7; font-size: 14px;">Select an object to edit its properties.</p>';
        }

        function updateObjectProperty(property, value) {
            const activeObject = canvas.getActiveObject();
            if (!activeObject) return;
            
            const numValue = parseFloat(value);
            activeObject.set(property, isNaN(numValue) ? value : numValue);
            canvas.renderAll();
            saveState();
        }

        // Action functions - ALL DEFINED HERE
        function deleteSelected() {
            const activeObjects = canvas.getActiveObjects();
            if (activeObjects.length) {
                const filteredObjects = activeObjects.filter(obj => obj.name !== 'background-image');
                if (filteredObjects.length > 0) {
                    canvas.remove(...filteredObjects);
                    canvas.discardActiveObject();
                    saveState();
                }
            }
        }

        function duplicateSelected() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.name !== 'background-image') {
                activeObject.clone(function(cloned) {
                    cloned.set({
                        left: cloned.left + 20,
                        top: cloned.top + 20,
                        name: activeObject.name.replace(/\d+$/, '') + Date.now()
                    });
                    canvas.add(cloned);
                    canvas.setActiveObject(cloned);
                    saveState();
                });
            }
        }

        // History management
        function saveState() {
            if (!canvas) return;
            
            if (historyStep < history.length - 1) {
                history = history.slice(0, historyStep + 1);
            }
            
            const state = JSON.stringify(canvas.toJSON());
            history.push(state);
            historyStep = history.length - 1;
            
            // Limit history size
            if (history.length > 50) {
                history.shift();
                historyStep--;
            }
        }

        function undoAction() {
            if (historyStep > 0) {
                historyStep--;
                const state = history[historyStep];
                canvas.loadFromJSON(state, function() {
                    canvas.renderAll();
                    updateLayers();
                    updatePropertiesPanel();
                    backgroundImage = canvas.getObjects().find(obj => obj.name === 'background-image');
                });
            }
        }

        function redoAction() {
            if (historyStep < history.length - 1) {
                historyStep++;
                const state = history[historyStep];
                canvas.loadFromJSON(state, function() {
                    canvas.renderAll();
                    updateLayers();
                    updatePropertiesPanel();
                    backgroundImage = canvas.getObjects().find(obj => obj.name === 'background-image');
                });
            }
        }

        // Zoom functions
        function zoomIn() {
            zoomLevel = Math.min(zoomLevel * 1.2, 5);
            canvas.setZoom(zoomLevel);
        }

        function zoomOut() {
            zoomLevel = Math.max(zoomLevel / 1.2, 0.1);
            canvas.setZoom(zoomLevel);
        }

        function fitToScreen() {
            zoomLevel = 1;
            canvas.setZoom(zoomLevel);
            canvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
        }

        // Export functions
        function exportAs(format) {
            try {
                if (!canvas) {
                    showMessage('Canvas not initialized', 'error');
                    return;
                }
                
                const dataURL = canvas.toDataURL({
                    format: format === 'jpg' ? 'jpeg' : format,
                    quality: 0.95,
                    multiplier: 2
                });
                
                if (format === 'pdf') {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                        unit: 'px',
                        format: [canvas.width, canvas.height]
                    });
                    
                    pdf.addImage(dataURL, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save(`${posterData.title || 'poster'}.pdf`);
                } else {
                    const link = document.createElement('a');
                    link.download = `${posterData.title || 'poster'}.${format}`;
                    link.href = dataURL;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                
                showMessage(`Successfully exported as ${format.toUpperCase()}!`, 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showMessage('Failed to export image. Please try again.', 'error');
            }
        }

        // Save poster
        function savePoster() {
            try {
                if (!canvas || canvas.getObjects().length === 0) {
                    showMessage('Canvas is empty. Please add some content before saving.', 'error');
                    return;
                }
                
                const saveBtn = document.getElementById('saveBtn');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Saving...';
                saveBtn.disabled = true;
                
                const dataURL = canvas.toDataURL('image/png', 1.0);
                
                if (!dataURL || dataURL.length < 100) {
                    throw new Error('Generated image data is invalid');
                }
                
                document.getElementById('canvasData').value = dataURL;
                document.getElementById('saveForm').submit();
                
                showMessage('Poster saved successfully!', 'success');
                
            } catch (error) {
                console.error('Save error:', error);
                showMessage('Failed to save poster. Please try again.', 'error');
                
                const saveBtn = document.getElementById('saveBtn');
                saveBtn.innerHTML = '<i class="fas fa-save"></i>Save Changes';
                saveBtn.disabled = false;
            }
        }

        function previewPoster() {
            window.open('{{ url_for("poster.view", poster_id=poster.id) }}', '_blank');
        }

        function deletePoster() {
            if (confirm('Are you sure you want to delete this poster? This action cannot be undone.')) {
                // Create a form to submit the delete request
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("poster.delete", poster_id=poster.id) }}';
                
                // Add CSRF token if available
                const csrfToken = document.querySelector('meta[name="csrf-token"]');
                if (csrfToken) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrf_token';
                    csrfInput.value = csrfToken.getAttribute('content');
                    form.appendChild(csrfInput);
                }
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }
            
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'z':
                        e.preventDefault();
                        if (e.shiftKey) {
                            redoAction();
                        } else {
                            undoAction();
                        }
                        break;
                    case 's':
                        e.preventDefault();
                        savePoster();
                        break;
                    case 'd':
                        e.preventDefault();
                        duplicateSelected();
                        break;
                    case 'e':
                        e.preventDefault();
                        enhanceTextClarity();
                        break;
                    case 'f':
                        e.preventDefault();
                        autoFillWhiteSpace();
                        break;
                                            case 'g':
                            e.preventDefault();
                            enhancedAutoFillWhiteSpace();
                            break;
                        case 'l':
                            e.preventDefault();
                            addCompanyLogo();
                            break;
                        case 'Delete':
                            e.preventDefault();
                            deletePoster();
                            break;
                }
            }
            
            if (e.key === 'Delete' || e.key === 'Backspace') {
                e.preventDefault();
                deleteSelected();
            }
        });

        // Responsive handling
        window.addEventListener('resize', function() {
            if (canvas) {
                canvas.renderAll();
            }
        });

        // Credit functionality
        function toggleCreditField(fieldType) {
            const checkbox = document.getElementById('credit' + fieldType.charAt(0).toUpperCase() + fieldType.slice(1));
            const preview = document.getElementById(fieldType + 'Preview');
            
            if (checkbox.checked) {
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        function addSelectedCredits() {
            const selectedFields = [];
            const fieldMappings = {
                'name': { label: 'Full Name', value: '{{ current_user.full_name or "Your Name" }}' },
                'business': { label: 'Business Name', value: '{{ current_user.business_name or "Your Business" }}' },
                'phone': { label: 'Phone', value: '{{ current_user.phone or "+1 (555) 123-4567" }}' },
                'address': { label: 'Address', value: '{{ current_user.address or "123 Business St, City, State" }}' },
                'website': { label: 'Website', value: '{{ current_user.website or "www.yourwebsite.com" }}' },
                'social': { 
                    label: 'Social Media', 
                    value: `{% if current_user.facebook or current_user.instagram or current_user.twitter or current_user.linkedin %}{% if current_user.facebook %}Facebook: {{ current_user.facebook }}{% endif %}{% if current_user.instagram %}{% if current_user.facebook %}, {% endif %}Instagram: {{ current_user.instagram }}{% endif %}{% if current_user.twitter %}{% if current_user.facebook or current_user.instagram %}, {% endif %}Twitter: {{ current_user.twitter }}{% endif %}{% if current_user.linkedin %}{% if current_user.facebook or current_user.instagram or current_user.twitter %}, {% endif %}LinkedIn: {{ current_user.linkedin }}{% endif %}{% else %}@yourhandle{% endif %}`
                },
                'logo': { label: 'Company Logo', value: '{{ current_user.logo_filename or "No logo uploaded" }}' },
                'email': { label: 'Email', value: '{{ current_user.email }}' },
                'username': { label: 'Username/ID', value: '@{{ current_user.username }}' }
            };

            // Check which fields are selected
            Object.keys(fieldMappings).forEach(field => {
                const checkbox = document.getElementById('credit' + field.charAt(0).toUpperCase() + field.slice(1));
                if (checkbox && checkbox.checked) {
                    selectedFields.push(fieldMappings[field]);
                }
            });

            if (selectedFields.length === 0) {
                showMessage('Please select at least one credit field to add.', 'error');
                return;
            }

            // Add credit text to canvas
            addCreditText(selectedFields);
            
            // Reset checkboxes
            Object.keys(fieldMappings).forEach(field => {
                const checkbox = document.getElementById('credit' + field.charAt(0).toUpperCase() + field.slice(1));
                if (checkbox) {
                    checkbox.checked = false;
                    toggleCreditField(field);
                }
            });

            showMessage('Credit information added successfully!', 'success');
        }

        function addCreditText(creditFields) {
            const canvasWidth = canvas.getWidth();
            const canvasHeight = canvas.getHeight();
            
            // Check if logo is selected
            const logoSelected = creditFields.some(field => field.label === 'Company Logo');
            
            // Create credit text with clear formatting
            let creditText = '';
            creditFields.forEach((field, index) => {
                if (field.label !== 'Company Logo') { // Skip logo from text
                    if (index > 0) creditText += '\n';
                    creditText += `${field.label}: ${field.value}`;
                }
            });

            // Create text object with clear, readable styling
            const creditTextObj = new fabric.Textbox(creditText, {
                left: canvasWidth - 250, // Position on right side
                top: canvasHeight - 150, // Position near bottom
                width: 230,
                fontSize: 14,
                fill: '#2c3e50', // Dark color for readability
                fontFamily: 'Arial, sans-serif',
                fontWeight: '500',
                backgroundColor: 'rgba(255, 255, 255, 0.9)', // Semi-transparent white background
                padding: 12,
                borderRadius: 8,
                borderColor: '#4A90E2',
                borderWidth: 2,
                cornerStyle: 'circle',
                cornerColor: '#4A90E2',
                cornerSize: 8,
                name: 'credit-info-' + Date.now(),
                selectable: true,
                editable: true,
                lockRotation: false,
                lockScalingX: false,
                lockScalingY: false,
                lockMovementX: false,
                lockMovementY: false
            });

            canvas.add(creditTextObj);
            canvas.setActiveObject(creditTextObj);
            
            // Add logo if selected
            if (logoSelected) {
                addCompanyLogo();
            }
            
            saveState();
            updateLayers();
        }

        // Auto-fill white space with user information
        function autoFillWhiteSpace() {
            if (!posterData.displayedFields || posterData.displayedFields.length === 0) {
                showMessage('No profile fields were selected during poster generation. Please use the credit options above.', 'error');
                return;
            }

            const fieldMappings = {
                'full_name': { label: 'Full Name', value: posterData.userProfile.full_name },
                'business_name': { label: 'Business Name', value: posterData.userProfile.business_name },
                'phone': { label: 'Phone', value: posterData.userProfile.phone },
                'address': { label: 'Address', value: posterData.userProfile.address },
                'website': { label: 'Website', value: posterData.userProfile.website },
                'facebook': { label: 'Facebook', value: posterData.userProfile.facebook },
                'instagram': { label: 'Instagram', value: posterData.userProfile.instagram },
                'twitter': { label: 'Twitter', value: posterData.userProfile.twitter },
                'linkedin': { label: 'LinkedIn', value: posterData.userProfile.linkedin },
                'email': { label: 'Email', value: posterData.userProfile.email },
                'username': { label: 'Username/ID', value: '@' + posterData.userProfile.username },
                'logo': { label: 'Company Logo', value: posterData.userProfile.logo_filename || 'No logo uploaded' }
            };

            // Filter only the fields that were selected during generation
            let selectedFields = posterData.displayedFields
                .filter(field => fieldMappings[field] && fieldMappings[field].value)
                .map(field => fieldMappings[field]);

            // If no fields were selected during generation, use all available fields
            if (selectedFields.length === 0) {
                selectedFields = Object.values(fieldMappings)
                    .filter(field => field.value && field.value !== 'No logo uploaded' && field.value !== '@yourhandle');
            }

            // Prioritize company information
            const priorityFields = ['business_name', 'full_name', 'email', 'phone', 'website'];
            selectedFields.sort((a, b) => {
                const aPriority = priorityFields.indexOf(a.label.toLowerCase().replace(' ', '_'));
                const bPriority = priorityFields.indexOf(b.label.toLowerCase().replace(' ', '_'));
                if (aPriority === -1 && bPriority === -1) return 0;
                if (aPriority === -1) return 1;
                if (bPriority === -1) return -1;
                return aPriority - bPriority;
            });

            if (selectedFields.length === 0) {
                showMessage('No valid profile information found. Please check your profile settings.', 'error');
                return;
            }

            // Find empty areas and add text strategically
            addStrategicText(selectedFields);
            
            showMessage(`Added ${selectedFields.length} profile fields to fill white space!`, 'success');
        }

        function addStrategicText(fields) {
            const canvasWidth = canvas.getWidth();
            const canvasHeight = canvas.getHeight();
            
            // Define comprehensive positions to completely fill white space
            const positions = [
                // Top area - completely fill the top white space
                { x: 20, y: 10, width: canvasWidth - 40, height: 60, area: 'top-full' },
                { x: 20, y: 80, width: canvasWidth - 40, height: 60, area: 'top-full-2' },
                
                // Left area - fill left white space
                { x: 10, y: 150, width: 150, height: 80, area: 'left-top' },
                { x: 10, y: 240, width: 150, height: 80, area: 'left-center' },
                { x: 10, y: 330, width: 150, height: 80, area: 'left-bottom' },
                { x: 10, y: 420, width: 150, height: 80, area: 'left-bottom-2' },
                
                // Right area - fill right white space
                { x: canvasWidth - 160, y: 150, width: 150, height: 80, area: 'right-top' },
                { x: canvasWidth - 160, y: 240, width: 150, height: 80, area: 'right-center' },
                { x: canvasWidth - 160, y: 330, width: 150, height: 80, area: 'right-bottom' },
                { x: canvasWidth - 160, y: 420, width: 150, height: 80, area: 'right-bottom-2' },
                
                // Bottom area - completely fill the bottom white space
                { x: 20, y: canvasHeight - 120, width: canvasWidth - 40, height: 60, area: 'bottom-full' },
                { x: 20, y: canvasHeight - 60, width: canvasWidth - 40, height: 40, area: 'bottom-full-2' },
                
                // Additional positions for more coverage
                { x: 170, y: 150, width: canvasWidth - 340, height: 60, area: 'center-top' },
                { x: 170, y: 220, width: canvasWidth - 340, height: 60, area: 'center-middle' },
                { x: 170, y: 290, width: canvasWidth - 340, height: 60, area: 'center-bottom' },
                { x: 170, y: 360, width: canvasWidth - 340, height: 60, area: 'center-bottom-2' }
            ];

            let fieldIndex = 0;
            positions.forEach((pos, index) => {
                if (fieldIndex < fields.length) {
                    const field = fields[fieldIndex];
                    
                    // Create more comprehensive text content
                    let text = '';
                    if (pos.area.includes('top') || pos.area.includes('bottom')) {
                        // Full width areas get company name and contact info
                        text = `${field.label}: ${field.value}`;
                        if (fieldIndex + 1 < fields.length) {
                            const nextField = fields[fieldIndex + 1];
                            text += ` | ${nextField.label}: ${nextField.value}`;
                            fieldIndex++; // Skip next field since we used it
                        }
                    } else {
                        // Side areas get individual field info
                        text = `${field.label}: ${field.value}`;
                    }
                    
                    // Create text object with professional styling
                    const textObj = new fabric.Textbox(text, {
                        left: pos.x,
                        top: pos.y,
                        width: pos.width,
                        fontSize: pos.area.includes('top') || pos.area.includes('bottom') ? 18 : 14,
                        fill: '#2c3e50',
                        fontFamily: 'Arial, sans-serif',
                        fontWeight: '600',
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        padding: 12,
                        borderRadius: 8,
                        borderColor: '#4A90E2',
                        borderWidth: 2,
                        cornerStyle: 'circle',
                        cornerColor: '#4A90E2',
                        cornerSize: 8,
                        name: `auto-fill-${field.label.toLowerCase().replace(' ', '-')}-${Date.now()}`,
                        selectable: true,
                        editable: true,
                        lockRotation: false,
                        lockScalingX: false,
                        lockScalingY: false,
                        lockMovementX: false,
                        lockMovementY: false
                    });

                    canvas.add(textObj);
                    fieldIndex++;
                }
            });

            // If we have more fields than positions, add them in a compact format
            if (fieldIndex < fields.length) {
                const remainingFields = fields.slice(fieldIndex);
                let compactText = '';
                remainingFields.forEach((field, index) => {
                    if (index > 0) compactText += ' | ';
                    compactText += `${field.label}: ${field.value}`;
                });

                const compactTextObj = new fabric.Textbox(compactText, {
                    left: 50,
                    top: canvasHeight - 80,
                    width: canvasWidth - 100,
                    fontSize: 14,
                    fill: '#2c3e50',
                    fontFamily: 'Arial, sans-serif',
                    fontWeight: '500',
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    padding: 8,
                    borderRadius: 6,
                    borderColor: '#4A90E2',
                    borderWidth: 1,
                    cornerStyle: 'circle',
                    cornerColor: '#4A90E2',
                    cornerSize: 6,
                    name: `auto-fill-compact-${Date.now()}`,
                    selectable: true,
                    editable: true
                });

                canvas.add(compactTextObj);
            }

            // Add logo if available
            addCompanyLogo();
        }

        function addCompanyLogo() {
            if (posterData.userProfile.logo_filename) {
                const logoUrl = '/static/uploads/logos/' + posterData.userProfile.logo_filename;
                
                fabric.Image.fromURL(logoUrl, function(img) {
                    if (img) {
                        // Scale logo to reasonable size
                        const maxSize = 100;
                        const scale = Math.min(maxSize / img.width, maxSize / img.height);
                        
                        img.set({
                            left: canvas.getWidth() - 120,
                            top: 20,
                            scaleX: scale,
                            scaleY: scale,
                            name: 'company-logo-' + Date.now(),
                            selectable: true,
                            lockRotation: false,
                            lockScalingX: false,
                            lockScalingY: false,
                            lockMovementX: false,
                            lockMovementY: false,
                            cornerStyle: 'circle',
                            borderColor: '#4A90E2',
                            cornerColor: '#4A90E2'
                        });
                        
                        canvas.add(img);
                        canvas.renderAll();
                        saveState();
                        updateLayers();
                        showMessage('Company logo added successfully!', 'success');
                    } else {
                        showMessage('Error loading logo image.', 'error');
                    }
                }, { crossOrigin: 'anonymous' });
            } else {
                showMessage('No logo uploaded. Please upload a logo in your profile settings.', 'error');
            }
        }

            saveState();
            updateLayers();
        }

        // Enhanced text clarity function
        function enhanceTextClarity() {
            const activeObject = canvas.getActiveObject();
            if (!activeObject || (activeObject.type !== 'textbox' && activeObject.type !== 'text')) {
                showMessage('Please select a text object to enhance.', 'error');
                return;
            }

            // Enhance text readability
            activeObject.set({
                fill: '#2c3e50', // Dark color for better contrast
                backgroundColor: 'rgba(255, 255, 255, 0.9)', // Semi-transparent white background
                padding: 12,
                borderRadius: 8,
                borderColor: '#4A90E2',
                borderWidth: 2,
                shadow: new fabric.Shadow({
                    color: 'rgba(0, 0, 0, 0.3)',
                    blur: 4,
                    offsetX: 2,
                    offsetY: 2
                }),
                fontFamily: 'Arial, sans-serif',
                fontWeight: '600'
            });

            canvas.renderAll();
            saveState();
            showMessage('Text clarity enhanced!', 'success');
        }

        function addText(x, y) {
            const text = new fabric.Textbox('Click to edit text', {
                left: x - 75,
                top: y - 15,
                width: 200,
                fontSize: 32,
                fill: '#2c3e50', // Darker color for better readability
                fontFamily: 'Arial, sans-serif',
                fontWeight: '600',
                name: 'text-' + Date.now(),
                cornerStyle: 'circle',
                borderColor: '#4A90E2',
                cornerColor: '#4A90E2',
                backgroundColor: 'rgba(255, 255, 255, 0.8)', // Semi-transparent background
                padding: 8,
                borderRadius: 6,
                shadow: new fabric.Shadow({
                    color: 'rgba(0, 0, 0, 0.3)',
                    blur: 4,
                    offsetX: 2,
                    offsetY: 2
                })
            });
            
            canvas.add(text);
            canvas.setActiveObject(text);
            setTool('select');
            saveState();
        }

        // Delete poster function
        function deletePoster() {
            if (confirm('Are you sure you want to delete this poster? This action cannot be undone.')) {
                // Show loading state
                const deleteBtn = document.querySelector('button[onclick="deletePoster()"]');
                if (deleteBtn) {
                    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                    deleteBtn.disabled = true;
                }
                
                // Redirect to delete URL
                window.location.href = '/poster/{{ poster.id }}/delete';
            }
        }

        // Enhanced auto-fill function with better text filling
        function enhancedAutoFillWhiteSpace() {
            if (!posterData.displayedFields || posterData.displayedFields.length === 0) {
                showMessage('No profile fields were selected during poster generation. Please use the credit options above.', 'error');
                return;
            }

            const fieldMappings = {
                'full_name': { label: 'Full Name', value: posterData.userProfile.full_name },
                'business_name': { label: 'Business Name', value: posterData.userProfile.business_name },
                'phone': { label: 'Phone', value: posterData.userProfile.phone },
                'address': { label: 'Address', value: posterData.userProfile.address },
                'website': { label: 'Website', value: posterData.userProfile.website },
                'facebook': { label: 'Facebook', value: posterData.userProfile.facebook },
                'instagram': { label: 'Instagram', value: posterData.userProfile.instagram },
                'twitter': { label: 'Twitter', value: posterData.userProfile.twitter },
                'linkedin': { label: 'LinkedIn', value: posterData.userProfile.linkedin },
                'email': { label: 'Email', value: posterData.userProfile.email },
                'username': { label: 'Username/ID', value: '@' + posterData.userProfile.username },
                'logo': { label: 'Company Logo', value: posterData.userProfile.logo_filename || 'No logo uploaded' }
            };

            // Filter only the fields that were selected during generation
            let selectedFields = posterData.displayedFields
                .filter(field => fieldMappings[field] && fieldMappings[field].value)
                .map(field => fieldMappings[field]);

            // If no fields were selected during generation, use all available fields
            if (selectedFields.length === 0) {
                selectedFields = Object.values(fieldMappings)
                    .filter(field => field.value && field.value !== 'No logo uploaded' && field.value !== '@yourhandle');
            }

            // Prioritize company information
            const priorityFields = ['business_name', 'full_name', 'email', 'phone', 'website'];
            selectedFields.sort((a, b) => {
                const aPriority = priorityFields.indexOf(a.label.toLowerCase().replace(' ', '_'));
                const bPriority = priorityFields.indexOf(b.label.toLowerCase().replace(' ', '_'));
                if (aPriority === -1 && bPriority === -1) return 0;
                if (aPriority === -1) return 1;
                if (bPriority === -1) return -1;
                return aPriority - bPriority;
            });

            if (selectedFields.length === 0) {
                showMessage('No valid profile information found. Please check your profile settings.', 'error');
                return;
            }

            // Find empty areas and add text strategically with better formatting
            addEnhancedStrategicText(selectedFields);
            
            showMessage(`Added ${selectedFields.length} profile fields to fill white space!`, 'success');
        }

        function addEnhancedStrategicText(fields) {
            const canvasWidth = canvas.getWidth();
            const canvasHeight = canvas.getHeight();
            
            // Define comprehensive positions to completely fill white space
            const positions = [
                // Top area - completely fill the top white space
                { x: 20, y: 10, width: canvasWidth - 40, height: 60, area: 'top-full' },
                { x: 20, y: 80, width: canvasWidth - 40, height: 60, area: 'top-full-2' },
                
                // Left area - fill left white space
                { x: 10, y: 150, width: 150, height: 80, area: 'left-top' },
                { x: 10, y: 240, width: 150, height: 80, area: 'left-center' },
                { x: 10, y: 330, width: 150, height: 80, area: 'left-bottom' },
                { x: 10, y: 420, width: 150, height: 80, area: 'left-bottom-2' },
                
                // Right area - fill right white space
                { x: canvasWidth - 160, y: 150, width: 150, height: 80, area: 'right-top' },
                { x: canvasWidth - 160, y: 240, width: 150, height: 80, area: 'right-center' },
                { x: canvasWidth - 160, y: 330, width: 150, height: 80, area: 'right-bottom' },
                { x: canvasWidth - 160, y: 420, width: 150, height: 80, area: 'right-bottom-2' },
                
                // Bottom area - completely fill the bottom white space
                { x: 20, y: canvasHeight - 120, width: canvasWidth - 40, height: 60, area: 'bottom-full' },
                { x: 20, y: canvasHeight - 60, width: canvasWidth - 40, height: 40, area: 'bottom-full-2' },
                
                // Additional positions for more coverage
                { x: 170, y: 150, width: canvasWidth - 340, height: 60, area: 'center-top' },
                { x: 170, y: 220, width: canvasWidth - 340, height: 60, area: 'center-middle' },
                { x: 170, y: 290, width: canvasWidth - 340, height: 60, area: 'center-bottom' },
                { x: 170, y: 360, width: canvasWidth - 340, height: 60, area: 'center-bottom-2' }
            ];

            let fieldIndex = 0;
            positions.forEach((pos, index) => {
                if (fieldIndex < fields.length) {
                    const field = fields[fieldIndex];
                    
                    // Create more comprehensive text content with better formatting
                    let text = '';
                    
                    if (pos.area.includes('full')) {
                        // For full-width areas, combine multiple fields
                        const remainingFields = fields.slice(fieldIndex, fieldIndex + 3);
                        text = remainingFields.map(f => `${f.label}: ${f.value}`).join(' | ');
                        fieldIndex += Math.min(3, remainingFields.length);
                    } else {
                        // For smaller areas, use single field with enhanced formatting
                        text = `${field.label}: ${field.value}`;
                        fieldIndex++;
                    }
                    
                    // Create enhanced text object with better styling
                    const textObj = new fabric.Textbox(text, {
                        left: pos.x,
                        top: pos.y,
                        width: pos.width,
                        fontSize: pos.area.includes('full') ? 18 : 16,
                        fill: '#2c3e50', // Dark color for better readability
                        fontFamily: 'Arial, sans-serif',
                        fontWeight: '600',
                        name: 'company-info-' + Date.now() + '-' + index,
                        cornerStyle: 'circle',
                        borderColor: '#4A90E2',
                        cornerColor: '#4A90E2',
                        backgroundColor: 'rgba(255, 255, 255, 0.9)', // More opaque background
                        padding: 10,
                        borderRadius: 8,
                        shadow: new fabric.Shadow({
                            color: 'rgba(0, 0, 0, 0.3)',
                            blur: 6,
                            offsetX: 3,
                            offsetY: 3
                        }),
                        textAlign: 'center',
                        lockRotation: true,
                        lockScalingX: false,
                        lockScalingY: false,
                        lockMovementX: false,
                        lockMovementY: false
                    });
                    
                    canvas.add(textObj);
                }
            });
            
            canvas.renderAll();
            saveState();
            updateLayers();
        }

        console.log('🎨 Postasy Standalone Editor script loaded and ready!');
    </script>
</body>
</html>